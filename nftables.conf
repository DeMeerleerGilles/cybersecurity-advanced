#!/usr/sbin/nft -f

flush ruleset

#
# Zone definitions
#
define WAN = "eth0"
define EXTERNAL = "eth1"
define INTERNAL = "eth2"

define fake_internet = 192.168.62.0/24
define dmz_net = 172.30.10.0/24
define intranet_net = 172.30.20.0/24

#
# FILTER TABLE
#
table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;

        # Allow loopback
        iif lo accept

        # Allow established connections
        ct state { established, related } accept

        # Allow ICMP (ping)
        ip protocol icmp accept

        # Allow SSH from internal network and DMZ
        ip saddr { $intranet_net, $dmz_net } tcp dport 22 accept

        # Optional: allow SSH from fake internet (Kali) for testing
        ip saddr 192.168.62.110 tcp dport 22 accept

        ip saddr 192.168.62.42 ip protocol esp accept
    }

    chain forward {
        type filter hook forward priority 0; policy drop;

        # Allow established connections
        ct state { established, related } accept

        # LAN → WAN
        iifname $INTERNAL oifname $WAN accept

        # LAN ↔ DMZ
        ip saddr $intranet_net ip daddr $dmz_net accept
        ip saddr $dmz_net ip daddr $intranet_net accept

        # Fake internet → DMZ webserver
        ip saddr $fake_internet ip daddr $dmz_net tcp dport {80,443} accept
        ip saddr $fake_internet ip daddr $dmz_net icmp type echo-request accept

        # Fake internet → Internal DNS
        ip saddr $fake_internet ip daddr $intranet_net udp dport 53 accept
        ip saddr $fake_internet ip daddr $intranet_net tcp dport 53 accept

        # Fake internet → DMZ optional services (Flask / Java)
        ip saddr $fake_internet ip daddr $dmz_net tcp dport {8000,9200} accept

        ip saddr 172.10.10.0/24 ip daddr { $dmz_net, $intranet_net } accept

        # Toestaan van antwoordverkeer van Company naar remote LAN
        ip saddr { $dmz_net, $intranet_net } ip daddr 172.10.10.0/24 accept

        # Allow return traffic
        ip saddr $dmz_net ip daddr $fake_internet accept

        # Drop all other fake internet traffic
        ip saddr $fake_internet drop
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}

#
# NAT TABLE
#
table ip nat {
    chain prerouting {
        type nat hook prerouting priority -100;
    }

    chain postrouting {
        type nat hook postrouting priority 100;

        # Masquerade all traffic going to WAN
        oifname $WAN ip saddr { $intranet_net, $dmz_net } masquerade

        # Masquerade fake_internet → DMZ
        oifname $INTERNAL ip saddr $fake_internet ip daddr $dmz_net masquerade
    }
}
