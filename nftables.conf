#!/usr/sbin/nft -f
flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;
        ct state established,related accept
        ct state new tcp dport 22 accept
        ct state new tcp dport 2222 accept
        ct state new udp dport 1194 accept
        iif lo accept
        ip protocol icmp accept
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
        ip protocol icmp accept
        ct state established,related accept
        
        # Existing allow rules
        ip saddr 192.168.62.253 tcp dport 22 ct state new accept
        ip saddr 172.30.0.0/17 accept
        
        # New rule: Allow 172.30.128.4 to SSH to 172.30.0.15
        ip saddr 172.30.10.10 ip daddr 172.30.0.15 tcp dport 22 ct state new accept

        # Other specific allows
        ip saddr 172.30.10.10 ip daddr 172.30.0.15 tcp dport 3306 accept
        ip saddr 172.30.10.10 tcp dport { 80, 443 } accept     
        ip daddr 172.30.10.10 tcp dport 80 accept
        
        # DNS rules
        ip daddr 172.30.20.4 tcp dport 53 accept
        ip daddr 172.30.20.4 udp dport 53 accept
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }
}