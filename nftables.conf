#!/usr/sbin/nft -f

flush ruleset

# ----------------------------
# 1. Definities & Variabelen
# ----------------------------
define WAN = "eth0"
define EXTERNAL = "eth1"
define DMZ_IF = "eth2"
define INT_IF = "eth3"

# Netwerken
define fake_internet = 192.168.62.0/24
define dmz_net = 172.30.10.0/24
define intranet_net = 172.30.20.0/24

# Hosts
define webserver = 172.30.10.10
define dns_server = 172.30.20.4
define siem_server = 172.30.20.50
define db_server = 172.30.20.15

table inet filter {
    # ----------------------------
    # 2. Input Chain (Verkeer naar de router)
    # ----------------------------
    chain input {
        type filter hook input priority 0; policy drop;

        # Accepteer localhost en bestaande connecties
        iif lo accept
        ct state established,related accept

        # ICMP (Ping) naar de router zelf toestaan
        ip protocol icmp accept

        # SSH toestaan van Fake Internet (Beheer) EN Interne netwerken
        # Dit zorgt dat je op de router kunt inloggen om door te springen.
        ip saddr { $fake_internet, $intranet_net, $dmz_net } tcp dport { 22, 2222 } accept
    }
    }

    # ----------------------------
    # 3. Forward Chain (Verkeer door de router)
    # ----------------------------
    chain forward {
        type filter hook forward priority 0; policy drop;

        # A. BASIS & PING
        ct state established,related accept
        
        # ICMP (Ping) doorlaten (Zodat je test.sh werkt!)
        ip protocol icmp accept

        # B. SSH DOORVOEREN (Directe routing, zonder jumpstation)
        meta l4proto tcp tcp dport { 22, 2222 } accept

        # C. DNS (Cruciaal voor alles)
        ip daddr $dns_server udp dport 53 accept
        ip daddr $dns_server tcp dport 53 accept
        
        # DNS Server mag naar buiten
        ip saddr $dns_server oifname { $WAN, $EXTERNAL } udp dport 53 accept
        ip saddr $dns_server oifname { $WAN, $EXTERNAL } tcp dport 53 accept

        # D. WEBSERVER
        ip daddr $webserver tcp dport { 80, 443, 8000, 9200 } accept

        # E. WAZUH SIEM (Logs ontvangen)
        ip daddr $siem_server tcp dport { 1514, 1515 } accept
        ip daddr $siem_server udp dport { 1514, 1515 } accept

        # F. VPN PASSTHROUGH
        udp dport 1194 accept
        udp dport { 500, 4500 } accept
        ip protocol esp accept

        # G. UITGAAND VERKEER (Internet toegang)
        iifname $INT_IF oifname { $WAN, $EXTERNAL } accept
        iifname $DMZ_IF oifname { $WAN, $EXTERNAL } accept

        # H. INTERNE TRAFFIC
        # Intranet -> DMZ (Volledig toegang)
        iifname $INT_IF oifname $DMZ_IF accept
        
        # DMZ -> Intranet (Beperkt: Webserver -> DB)
        ip saddr $webserver ip daddr $db_server tcp dport 3306 accept
    }

    # ----------------------------
    # 4. Output Chain (Verkeer VANUIT de router)
    # ----------------------------
    chain output {
        # Policy accept zorgt dat de 2e stap van de Jump (Router -> DB) altijd mag.
        type filter hook output priority 0; policy accept;
    }
}

# ----------------------------
# 5. NAT
# ----------------------------
table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100;
        oifname { $WAN, $EXTERNAL } masquerade
    }
}